<!DOCTYPE html>
<html>
  <head>
    <title>SF Sealions 2015 Chat App - Matt Lao &amp; Curtis Seaton</title>

    <link rel="stylesheet" href="stylesheets/reset.css">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">

    <script src="https://cdn.firebase.com/js/client/2.0.2/firebase.js"></script>

    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script>

    <link rel="stylesheet" href="stylesheets/styles.css">
  </head>
  <body>
    <header>
      <h1 class="page-title">Sf Sea Lions Chat</h1>
    </header>
    <div class="col-sm-7">
    <script>
    var ref = new Firebase("https://sfsealionschat.firebaseio.com/");
var messagesRef = ref.child('messages');
var usersRef = ref.child('users');
var currentUser = null;
//STEP 2
  $('#login').on("click", function () {
    authenticate();
  });
//STEP 3
var authenticate = function() {
  usersRef.authWithOAuthPopup('twitter', function (error, user) {
    if (error) {
      console.log(error);
    } else if (user) {
      usersRef.child(user.uid).set({username: user.twitter.username, pic: user.twitter.cachedUserProfile.profile_image_url_https});
    }
  });
};
  //Save user's auth state
  usersRef.onAuth(function (user) {
    currentUser = user;
  });
//STEP 4: Display a list of users who have logged in
usersRef.on('child_added', function (snapshot) {
  var user = snapshot.val();
  $("<div id='user'><img src=" + user.pic + "/><span id='username'>@" + user.username + "</span></div>").appendTo($('#here'));
});
//STEP 5: Store messages in Firebase
$('#tweet-submit').on('click', function () {
  if (currentUser !== null) {
    var message = $('#msgInput').val();
    //Send the message to Firebase
    messagesRef.push({user: currentUser.uid, username: currentUser.twitter.username, message: message, published: new Date().getTime()});
    $('#msgInput').val('');
  } else {
    alert('You must login with Twitter to post!');
  }
});
//STEP 6: Add messages to DOM in realtime
messagesRef.orderByChild("published").on('child_added', function (snapshot) {
  var message = snapshot.val();
    $('#msg-box').prepend($("<div class='msg-text'>").text(message.username).append('<br/>').append($('<span/>').text(message.message)));
});
</script>
    </div>

    <div class="login-container col-sm-5">
      <div class="login-buttons">
          <button type="button" class="twitter-login btn btn-info">
            <i class="fa fa-twitter fa-lg"></i>
            Login with Twitter
          </button>
          <button type="button" class="google-login btn btn-danger">
            <i class="fa fa-google fa-lg"></i>
            Login with Google
          </button>
          <button type="button" class="github-login btn btn-default">
            <i class="fa fa-github fa-lg"></i>
            Login with Github
          </button>
          <h3>Active Users</h3>
        </div>
    </div>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src= "js/base.js"></script>
  </body>
</html>
